<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìö BookBuddy Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Times New Roman', Times, serif;
  }
  
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    min-height: 100vh;
    padding: 20px;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .header {
    text-align: center;
    padding: 30px 0;
    border-bottom: 3px solid rgba(255,255,255,0.2);
    margin-bottom: 30px;
  }
  
  .header h1 {
    font-size: 3.5em;
    font-weight: bold;
    margin-bottom: 10px;
  }
  
  .connection-box {
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .connection-box input {
    padding: 12px 20px;
    font-size: 1.2em;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.2);
    color: #fff;
    width: 300px;
    margin-right: 10px;
    font-family: 'Times New Roman', Times, serif;
  }
  
  .connection-box input::placeholder {
    color: rgba(255,255,255,0.6);
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 30px;
    border-radius: 50px;
    font-size: 1.2em;
    font-weight: bold;
    border: 3px solid;
    margin: 20px 0;
  }
  
  .status-badge.live {
    background: rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
    color: #4CAF50;
  }
  
  .status-badge.offline {
    background: rgba(244, 67, 54, 0.2);
    border-color: #F44336;
    color: #F44336;
  }
  
  .status-badge.connecting {
    background: rgba(255, 193, 7, 0.2);
    border-color: #FFC107;
    color: #FFC107;
  }
  
  .pulse-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  
  .pulse-dot.green { background: #4CAF50; }
  .pulse-dot.red { background: #F44336; }
  .pulse-dot.yellow { background: #FFC107; }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .card {
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    backdrop-filter: blur(10px);
  }
  
  .card h2 {
    font-size: 1.8em;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-box {
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
  }
  
  .stat-box .label {
    font-size: 1em;
    font-weight: bold;
    opacity: 0.8;
    margin-bottom: 8px;
  }
  
  .stat-box .value {
    font-size: 2em;
    font-weight: bold;
  }
  
  .btn {
    display: inline-block;
    padding: 12px 30px;
    border-radius: 50px;
    border: none;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Times New Roman', Times, serif;
  }
  
  .btn-primary {
    background: linear-gradient(to right, #f093fb 0%, #f5576c 100%);
    color: #fff;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
  }
  
  .btn-connect {
    background: linear-gradient(to right, #4CAF50, #45a049);
    color: #fff;
  }
  
  .btn-connect:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
  }
  
  .chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  table th, table td {
    padding: 15px;
    text-align: left;
    border-bottom: 2px solid rgba(255,255,255,0.1);
  }
  
  table th {
    font-size: 1.1em;
    font-weight: bold;
  }
  
  table td {
    font-size: 1.2em;
    font-weight: bold;
  }
  
  .status-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  .status-dot.on {
    background: #4CAF50;
    box-shadow: 0 0 8px #4CAF50;
  }
  
  .status-dot.off {
    background: #666;
  }
  
  #result {
    margin-top: 15px;
    padding: 12px;
    border-radius: 12px;
    display: none;
    font-weight: bold;
  }
  
  #result.success {
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid #4CAF50;
    color: #4CAF50;
    display: block;
  }
  
  #result.error {
    background: rgba(244, 67, 54, 0.2);
    border: 2px solid #F44336;
    color: #F44336;
    display: block;
  }
</style>
</head>
<body>

<div class="container">
  
  <div class="header">
    <h1>üìö BOOKBUDDY DASHBOARD</h1>
    <p style="font-size:1.3em;">Your Smart Study Partner</p>
    
    <!-- Connection Input -->
    <div class="connection-box">
      <input type="text" id="ipInput" placeholder="Enter ESP32 IP (e.g., 192.168.1.100)">
      <button class="btn btn-connect" onclick="connect()">Connect</button>
    </div>
    
    <div id="statusBadge" class="status-badge offline">
      <div id="statusDot" class="pulse-dot red"></div>
      <span id="statusText">Not Connected</span>
    </div>
  </div>
  
  <!-- Quick Stats -->
  <div class="card">
    <h2>üìä LIVE STATUS</h2>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="label">Books Placed</div>
        <div class="value" id="bookCount">--</div>
      </div>
      <div class="stat-box">
        <div class="label">Emotion</div>
        <div class="value" id="emotion" style="font-size:1.5em;">--</div>
      </div>
      <div class="stat-box">
        <div class="label">Current Time</div>
        <div class="value" id="rtcTime" style="font-size:1.5em;">--:--:--</div>
      </div>
      <div class="stat-box">
        <div class="label">Total Study Time</div>
        <div class="value" id="totalTime">--</div>
      </div>
    </div>
  </div>
  
  <!-- Reading Progress Chart -->
  <div class="card">
    <h2>üìà READING PROGRESS (Minutes)</h2>
    <div class="chart-container">
      <canvas id="progressChart"></canvas>
    </div>
  </div>
  
  <!-- Book Status Table -->
  <div class="card">
    <h2>üìñ SUBJECT TRACKER</h2>
    <table>
      <thead>
        <tr>
          <th>Subject</th>
          <th>Status</th>
          <th>Total Time</th>
        </tr>
      </thead>
      <tbody id="booksTable">
        <tr><td colspan="3" style="text-align:center;">Connect to BookBuddy to see data...</td></tr>
      </tbody>
    </table>
  </div>
  
  <!-- Controls -->
  <div class="card">
    <h2>‚öôÔ∏è CONTROLS</h2>
    <div style="text-align:center;">
      <button class="btn btn-primary" onclick="syncTime()">üïê Sync RTC Time</button>
      <div id="result"></div>
    </div>
  </div>
  
</div>

<script>
  // ===== GLOBAL VARIABLES =====
  let ESP32_IP = localStorage.getItem('esp32_ip') || '';
  let ws = null;
  let progressChart = null;
  
  // Load saved IP on page load
  if (ESP32_IP) {
    document.getElementById('ipInput').value = ESP32_IP;
  }
  
  // Initialize Chart
  const ctx = document.getElementById('progressChart').getContext('2d');
  progressChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['English', 'Hindi', 'Maths', 'Marathi', 'Science'],
      datasets: [{
        label: 'Reading Time (minutes)',
        data: [0, 0, 0, 0, 0],
        backgroundColor: [
          'rgba(255, 99, 132, 0.7)',
          'rgba(54, 162, 235, 0.7)',
          'rgba(255, 206, 86, 0.7)',
          'rgba(75, 192, 192, 0.7)',
          'rgba(153, 102, 255, 0.7)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff', font: { size: 14, weight: 'bold' } },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff', font: { size: 14, weight: 'bold' } },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      },
      plugins: {
        legend: {
          labels: { color: '#fff', font: { size: 14, weight: 'bold' } }
        }
      }
    }
  });
  
  function updateStatus(state, text) {
    const badge = document.getElementById('statusBadge');
    const dot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    badge.className = 'status-badge ' + state;
    
    if (state === 'live') {
      dot.className = 'pulse-dot green';
    } else if (state === 'connecting') {
      dot.className = 'pulse-dot yellow';
    } else {
      dot.className = 'pulse-dot red';
    }
    
    statusText.textContent = text;
  }
  
  function updateUI(data) {
    if (data.status === 'live') {
      updateStatus('live', 'BookBuddy is LIVE!');
      
      // Books count
      document.getElementById('bookCount').textContent = (data.booksPlaced || 0) + ' / 5';
      
      // Emotion
      document.getElementById('emotion').textContent = data.emotion || '--';
      
      // RTC Time (show with seconds)
      if (data.time && data.time !== 'N/A') {
        const timePart = data.time.split('T')[1] || data.time;
        document.getElementById('rtcTime').textContent = timePart;
      }
      
      // Total study time
      const totalSecs = data.totalStudySeconds || 0;
      const totalMins = Math.floor(totalSecs / 60);
      const totalHours = Math.floor(totalMins / 60);
      const remMins = totalMins % 60;
      const remSecs = totalSecs % 60;
      
      let timeStr = '';
      if (totalHours > 0) {
        timeStr = totalHours + 'h ' + remMins + 'm';
      } else if (totalMins > 0) {
        timeStr = totalMins + 'm ' + remSecs + 's';
      } else {
        timeStr = totalSecs + 's';
      }
      document.getElementById('totalTime').textContent = timeStr;
      
      // Update chart
      const chartData = [];
      const books = data.books || [];
      
      const bookOrder = { 'English': 0, 'Hindi': 1, 'Maths': 2, 'Marathi': 3, 'Science': 4 };
      const chartArray = [0, 0, 0, 0, 0];
      
      books.forEach(book => {
        const mins = Math.floor(book.totalSeconds / 60);
        const index = bookOrder[book.name];
        if (index !== undefined) {
          chartArray[index] = mins;
        }
      });
      
      progressChart.data.datasets[0].data = chartArray;
      progressChart.update();
      
      // Update table
      let tableHTML = '';
      books.forEach(book => {
        const statusClass = book.present ? 'on' : 'off';
        const statusLabel = book.present ? 'On Rack' : 'Studying';
        
        const secs = book.totalSeconds;
        const mins = Math.floor(secs / 60);
        const hours = Math.floor(mins / 60);
        const remMin = mins % 60;
        const remSec = secs % 60;
        
        let timeStr = '';
        if (hours > 0) {
          timeStr = hours + 'h ' + remMin + 'm';
        } else if (mins > 0) {
          timeStr = mins + 'm ' + remSec + 's';
        } else {
          timeStr = secs + 's';
        }
        
        const icons = {
          'English': 'üìñ',
          'Hindi': 'üìï',
          'Maths': 'üìê',
          'Marathi': 'üìó',
          'Science': 'üî¨'
        };
        
        tableHTML += `<tr>
          <td>${icons[book.name] || 'üìö'} <strong>${book.name}</strong></td>
          <td><span class="status-dot ${statusClass}"></span>${statusLabel}</td>
          <td>${timeStr}</td>
        </tr>`;
      });
      document.getElementById('booksTable').innerHTML = tableHTML;
    }
  }
  
  function connect() {
    ESP32_IP = document.getElementById('ipInput').value.trim();
    
    if (!ESP32_IP) {
      alert('Please enter ESP32 IP address!');
      return;
    }
    
    // Save IP to localStorage
    localStorage.setItem('esp32_ip', ESP32_IP);
    
    // Close existing connection
    if (ws) {
      ws.close();
    }
    
    // Connect WebSocket
    connectWebSocket();
  }
  
  function connectWebSocket() {
    if (!ESP32_IP) {
      updateStatus('offline', 'No IP Address');
      return;
    }
    
    updateStatus('connecting', 'Connecting...');
    
    ws = new WebSocket(`ws://${ESP32_IP}/ws`);
    
    ws.onopen = () => {
      console.log('‚úì WebSocket connected');
      updateStatus('live', 'Connected!');
    };
    
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        updateUI(data);
      } catch (e) {
        console.error('Parse error:', e);
      }
    };
    
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      updateStatus('offline', 'Connection Error');
    };
    
    ws.onclose = () => {
      console.log('WebSocket closed');
      updateStatus('offline', 'Disconnected');
      
      // Auto-reconnect after 3 seconds
      setTimeout(() => {
        if (ESP32_IP) {
          console.log('Attempting to reconnect...');
          connectWebSocket();
        }
      }, 3000);
    };
  }
  
  async function syncTime() {
    if (!ESP32_IP) {
      alert('Please connect to BookBuddy first!');
      return;
    }
    
    const resultDiv = document.getElementById('result');
    
    try {
      const epoch = Math.floor(Date.now() / 1000);
      
      const response = await fetch(`http://${ESP32_IP}/api/synctime`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ epoch: epoch })
      });
      
      const data = await response.json();
      
      if (data.success) {
        resultDiv.className = 'success';
        resultDiv.textContent = '‚úÖ RTC synced to: ' + data.newTime;
      } else {
        throw new Error(data.error || 'Sync failed');
      }
      
    } catch (error) {
      resultDiv.className = 'error';
      resultDiv.textContent = '‚ùå Sync failed: ' + error.message;
    }
    
    resultDiv.style.display = 'block';
    setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
  }
  
  // Auto-connect if IP is saved
  if (ESP32_IP) {
    console.log('Auto-connecting to saved IP:', ESP32_IP);
    connectWebSocket();
  }
</script>

</body>
</html>
