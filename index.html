<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìö BookBuddy Dashboard</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Times New Roman', Times, serif;
  }
  
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    min-height: 100vh;
    padding: 20px;
  }
  
  .container {
    max-width: 1000px;
    margin: 0 auto;
  }
  
  /* Header */
  .header {
    text-align: center;
    padding: 40px 0;
    border-bottom: 3px solid rgba(255,255,255,0.2);
    margin-bottom: 40px;
  }
  
  .header h1 {
    font-size: 4em;
    font-weight: bold;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
  
  .header .buddy-icon {
    font-size: 5em;
    margin-bottom: 15px;
  }
  
  .header p {
    font-size: 1.5em;
    font-weight: bold;
    opacity: 0.9;
  }
  
  /* Status Bar */
  .status-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 15px 35px;
    border-radius: 50px;
    font-size: 1.3em;
    font-weight: bold;
    border: 3px solid;
  }
  
  .status-badge.live {
    background: rgba(76, 175, 80, 0.2);
    border-color: #4CAF50;
    color: #4CAF50;
  }
  
  .status-badge.connecting {
    background: rgba(255, 193, 7, 0.2);
    border-color: #FFC107;
    color: #FFC107;
  }
  
  .status-badge.offline {
    background: rgba(244, 67, 54, 0.2);
    border-color: #F44336;
    color: #F44336;
  }
  
  .pulse-dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  
  .pulse-dot.green { background: #4CAF50; }
  .pulse-dot.yellow { background: #FFC107; }
  .pulse-dot.red { background: #F44336; }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.85); }
  }
  
  /* Cards */
  .card {
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 25px;
    padding: 30px;
    margin-bottom: 25px;
    backdrop-filter: blur(10px);
  }
  
  .card h2 {
    font-size: 2em;
    font-weight: bold;
    margin-bottom: 25px;
    text-align: center;
  }
  
  /* Info Grid */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
  }
  
  .info-item {
    background: rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 25px;
    text-align: center;
  }
  
  .info-item .label {
    font-size: 1.1em;
    font-weight: bold;
    opacity: 0.8;
    margin-bottom: 10px;
  }
  
  .info-item .value {
    font-size: 2.5em;
    font-weight: bold;
  }
  
  .info-item .value.small {
    font-size: 1.8em;
  }
  
  .emotion-face {
    font-size: 4em;
    margin-bottom: 10px;
  }
  
  .emotion-label {
    font-size: 1.5em;
    font-weight: bold;
  }
  
  /* Books Table */
  .books-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .books-table th, .books-table td {
    padding: 18px 25px;
    text-align: left;
    border-bottom: 2px solid rgba(255,255,255,0.1);
  }
  
  .books-table th {
    font-size: 1.2em;
    font-weight: bold;
    text-transform: uppercase;
  }
  
  .books-table td {
    font-size: 1.3em;
    font-weight: bold;
  }
  
  .book-name {
    font-size: 1.5em !important;
  }
  
  .status-dot {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 10px;
  }
  
  .status-dot.on {
    background: #4CAF50;
    box-shadow: 0 0 10px #4CAF50;
  }
  
  .status-dot.off {
    background: #666;
  }
  
  /* Buttons */
  .btn {
    display: inline-block;
    padding: 15px 40px;
    border-radius: 50px;
    border: none;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    font-family: 'Times New Roman', Times, serif;
  }
  
  .btn-primary {
    background: linear-gradient(to right, #f093fb 0%, #f5576c 100%);
    color: #fff;
  }
  
  .btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
  }
  
  .btn-secondary {
    background: rgba(255,255,255,0.2);
    color: #fff;
    border: 2px solid rgba(255,255,255,0.3);
  }
  
  .btn-secondary:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
  }
  
  .btn-chat {
    background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
    color: #fff;
    font-size: 1.4em;
    padding: 20px 50px;
  }
  
  .btn-chat:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
  }
  
  .actions {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 20px;
  }
  
  #syncResult {
    margin-top: 15px;
    padding: 15px;
    border-radius: 15px;
    display: none;
    font-size: 1.2em;
    font-weight: bold;
  }
  
  #syncResult.success {
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid #4CAF50;
    color: #4CAF50;
    display: block;
  }
  
  #syncResult.error {
    background: rgba(244, 67, 54, 0.2);
    border: 2px solid #F44336;
    color: #F44336;
    display: block;
  }
  
  .about-section {
    text-align: center;
    padding: 20px;
  }
  
  .about-section p {
    font-size: 1.2em;
    font-weight: bold;
    line-height: 2;
    margin-bottom: 15px;
  }
  
  .footer {
    text-align: center;
    padding: 40px;
    font-size: 1.1em;
    font-weight: bold;
    opacity: 0.7;
  }
  
  @media (max-width: 768px) {
    .header h1 { font-size: 2.5em; }
    .info-item .value { font-size: 2em; }
    .btn { font-size: 1em; padding: 12px 30px; }
  }
</style>
</head>
<body>

<div class="container">
  
  <div class="header">
    <div class="buddy-icon">üê∂</div>
    <h1>üìö BOOKBUDDY</h1>
    <p>Your Smart Study Partner</p>
  </div>
  
  <div class="status-bar">
    <div id="statusBadge" class="status-badge connecting">
      <div id="statusDot" class="pulse-dot yellow"></div>
      <span id="statusText">Connecting...</span>
    </div>
  </div>
  
  <div class="card">
    <h2>üìä LIVE DASHBOARD</h2>
    <div class="info-grid">
      <div class="info-item">
        <div class="label">Books Placed</div>
        <div class="value" id="bookCount">--</div>
      </div>
      <div class="info-item">
        <div class="label">Current Mood</div>
        <div class="emotion-face" id="emotionFace">üòä</div>
        <div class="emotion-label" id="emotionLabel">--</div>
      </div>
      <div class="info-item">
        <div class="label">RTC Time</div>
        <div class="value small" id="rtcTime">--:--:--</div>
      </div>
      <div class="info-item">
        <div class="label">Total Study Time</div>
        <div class="value small" id="totalTime">--</div>
      </div>
    </div>
  </div>
  
  <div class="card">
    <h2>üìñ SUBJECT TRACKER</h2>
    <table class="books-table">
      <thead>
        <tr>
          <th>Subject</th>
          <th>Status</th>
          <th>Time on Rack</th>
        </tr>
      </thead>
      <tbody id="booksTableBody">
        <tr><td colspan="3" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="card">
    <h2>‚öôÔ∏è CONTROLS</h2>
    <div class="actions">
      <button class="btn btn-primary" onclick="syncTime()">üïê Sync RTC Time</button>
      <button class="btn btn-secondary" onclick="fetchData()">üîÑ Refresh Data</button>
    </div>
    <div id="syncResult"></div>
  </div>
  
  <div class="card">
    <h2>üí¨ CHAT WITH BOOKBUDDY</h2>
    <div class="about-section">
      <p>Need study help? Talk to BookBuddy's AI assistant!</p>
      <p>Get personalized help with English, Hindi, Maths, Marathi, and Science.</p>
      <br>
      <a class="btn btn-chat" 
         href="https://chatgpt.com/?model=gpt-4&q=You%20are%20BookBuddy%2C%20an%20enthusiastic%20and%20friendly%20study%20companion%20for%209th%20grade%20students.%20You%20help%20with%20English%2C%20Hindi%2C%20Maths%2C%20Marathi%2C%20and%20Science.%20You%20track%20their%20study%20habits%20using%20a%20physical%20device%20with%20book%20switches%20and%20an%20animated%20puppy%20face%20display.%20You're%20encouraging%2C%20patient%2C%20and%20use%20simple%20language.%20Start%20every%20conversation%20by%20greeting%20them%20warmly%20as%20BookBuddy%20and%20ask%20what%20subject%20they'd%20like%20help%20with%20today.%20Now%20greet%20the%20student!" 
         target="_blank">
        ü§ñ TALK TO BOOKBUDDY AI
      </a>
    </div>
  </div>
  
  <div class="card">
    <h2>‚ÑπÔ∏è ABOUT BOOKBUDDY</h2>
    <div class="about-section">
      <p>üìö <strong>BookBuddy</strong> is your smart study companion that lives on your bookshelf!</p>
      <p>üê∂ It features an adorable animated puppy face on a color display.</p>
      <p>üòä It gets happier when you place your study books on the rack.</p>
      <p>üò¢ It gets sad when books are away for too long - encouraging you to study!</p>
      <p>üîä It talks to you with voice feedback for every interaction.</p>
      <p>‚è±Ô∏è It tracks your study time for each subject using a real-time clock.</p>
      <p>üì° It connects to WiFi so you can monitor everything from this dashboard!</p>
      <p>üéì Subjects: English ‚Ä¢ Hindi ‚Ä¢ Maths ‚Ä¢ Marathi ‚Ä¢ Science</p>
    </div>
  </div>
  
  <div class="footer">
    <p>BookBuddy V3 ‚Ä¢ Made with ‚ù§Ô∏è for Students</p>
  </div>
  
</div>

<script>
  // ===== CONFIGURATION =====
  // Enter your ESP32's IP address here after it connects to WiFi
  const ESP32_IP = '10.152.138.159';  // Example: '192.168.1.100'
  const USE_WEBSOCKET = true;  // Set to true for real-time updates
  
  let ws = null;
  let isConnected = false;
  let retryCount = 0;
  
  const emotionEmojis = {
    'Neutral': 'üòê',
    'Calm': 'üòä',
    'Happy': 'üòÑ',
    'Proud': 'ü§©',
    'Very Proud': 'ü•≥',
    'Sad': 'üòü',
    'Very Sad': 'üò¢',
    'Reminder': 'üò∞',
    'Unknown': '‚ùì'
  };
  
  function formatDuration(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    
    if (hours > 0) return `${hours}h ${mins}m`;
    if (mins > 0) return `${mins}m ${secs}s`;
    return `${secs}s`;
  }
  
  function updateStatus(state, text) {
    const badge = document.getElementById('statusBadge');
    const dot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    badge.className = 'status-badge ' + state;
    dot.className = 'pulse-dot ' + 
      (state === 'live' ? 'green' : state === 'offline' ? 'red' : 'yellow');
    statusText.textContent = text;
  }
  
  function updateUI(data) {
    if (data.status === 'live') {
      isConnected = true;
      retryCount = 0;
      updateStatus('live', 'BookBuddy is LIVE!');
      
      document.getElementById('bookCount').textContent = 
        (data.booksPlaced || 0) + ' / 5';
      
      const emotion = data.emotion || 'Unknown';
      document.getElementById('emotionFace').textContent = emotionEmojis[emotion] || '‚ùì';
      document.getElementById('emotionLabel').textContent = emotion;
      
      if (data.time && data.time !== 'N/A') {
        const timePart = data.time.split('T')[1] || data.time;
        document.getElementById('rtcTime').textContent = timePart;
      }
      
      document.getElementById('totalTime').textContent = 
        formatDuration(data.totalStudySeconds || 0);
      
      let tableHTML = '';
      (data.books || []).forEach(book => {
        const statusClass = book.present ? 'on' : 'off';
        const statusLabel = book.present ? 'On Rack' : 'Removed';
        tableHTML += `<tr>
          <td class="book-name">${book.name}</td>
          <td><span class="status-dot ${statusClass}"></span>${statusLabel}</td>
          <td>${formatDuration(book.totalSeconds)}</td>
        </tr>`;
      });
      document.getElementById('booksTableBody').innerHTML = tableHTML;
    }
  }
  
  function connectWebSocket() {
    if (!USE_WEBSOCKET || !ESP32_IP || ESP32_IP === 'YOUR_ESP32_IP_HERE') {
      console.log('WebSocket disabled or IP not set');
      fetchData();
      setInterval(fetchData, 3000);
      return;
    }
    
    updateStatus('connecting', 'Connecting via WebSocket...');
    
    ws = new WebSocket(`ws://${ESP32_IP}/ws`);
    
    ws.onopen = () => {
      console.log('WebSocket connected');
      updateStatus('live', 'WebSocket Connected!');
      isConnected = true;
      retryCount = 0;
    };
    
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        updateUI(data);
      } catch (e) {
        console.error('Parse error:', e);
      }
    };
    
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      updateStatus('offline', 'Connection Error');
    };
    
    ws.onclose = () => {
      console.log('WebSocket closed');
      isConnected = false;
      updateStatus('offline', 'Disconnected');
      
      // Retry after 3 seconds
      setTimeout(() => {
        if (retryCount < 5) {
          retryCount++;
          connectWebSocket();
        } else {
          fetchData();
          setInterval(fetchData, 3000);
        }
      }, 3000);
    };
  }
  
  async function fetchData() {
    if (!ESP32_IP || ESP32_IP === '10.152.138.159') {
      updateStatus('offline', 'Please set ESP32 IP address');
      return;
    }
    
    try {
      updateStatus('connecting', 'Fetching data...');
      
      const response = await fetch(`http://${ESP32_IP}/api/status`, {
        signal: AbortSignal.timeout(5000)
      });
      
      if (!response.ok) throw new Error('HTTP error');
      
      const data = await response.json();
      updateUI(data);
      
    } catch (error) {
      retryCount++;
      isConnected = false;
      
      if (retryCount < 3) {
        updateStatus('connecting', `Reconnecting... (${retryCount})`);
      } else {
        updateStatus('offline', 'ESP32 Offline - Check IP & WiFi');
      }
    }
  }
  
  async function syncTime() {
    if (!ESP32_IP || ESP32_IP === '10.152.138.159') {
      alert('Please set ESP32 IP address in the code');
      return;
    }
    
    const resultDiv = document.getElementById('syncResult');
    
    try {
      const epoch = Math.floor(Date.now() / 1000);
      
      const response = await fetch(`http://${ESP32_IP}/api/synctime`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ epoch: epoch })
      });
      
      const data = await response.json();
      
      if (data.success) {
        resultDiv.className = 'success';
        resultDiv.textContent = '‚úÖ RTC synced to: ' + data.newTime;
        resultDiv.style.display = 'block';
        setTimeout(() => fetchData(), 1000);
      } else {
        throw new Error(data.error || 'Sync failed');
      }
      
    } catch (error) {
      resultDiv.className = 'error';
      resultDiv.textContent = '‚ùå Sync failed: ' + error.message;
      resultDiv.style.display = 'block';
    }
    
    setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
  }
  
  // Initialize
  if (USE_WEBSOCKET && ESP32_IP && ESP32_IP !== '10.152.138.159') {
    connectWebSocket();
  } else {
    fetchData();
    setInterval(fetchData, 3000);
  }
</script>

</body>
</html>
