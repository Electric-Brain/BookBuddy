<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Buddy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Times New Roman', Times, serif;
        }
        
        * {
            font-family: 'Times New Roman', Times, serif;
        }
        
        .status-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .book-card {
            transition: all 0.3s ease;
        }
        
        .book-card:hover {
            transform: translateY(-2px);
        }
        
        .connecting {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body class="h-full bg-gray-100">
    <div id="app" class="h-full w-full overflow-auto">
        <!-- Header -->
        <header class="bg-white border-b-4 border-black p-4">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div>
                    <h1 id="main-title" class="text-3xl font-bold text-black">üìö BOOK BUDDY DASHBOARD</h1>
                    <p class="text-lg font-bold text-black mt-1">Your Study Partner</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connection-status" class="flex items-center gap-2 px-4 py-2 border-2 border-black bg-gray-200">
                        <span id="status-dot" class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span id="status-text" class="font-bold text-black">DISCONNECTED</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto p-6">
            <!-- Connection Section -->
            <section class="bg-white border-4 border-black p-6 mb-6">
                <h2 class="text-2xl font-bold text-black mb-4">üîå CONNECTION</h2>
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 min-w-64">
                        <label class="block text-lg font-bold text-black mb-2">WEBSOCKET URL:</label>
                        <input type="text" id="ws-url" 
                               class="w-full p-3 border-2 border-black text-lg font-bold text-black bg-white"
                               placeholder="wss://your-esp32-url.local"
                               value="">
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="connect-btn" 
                                onclick="toggleConnection()"
                                class="px-6 py-3 bg-black text-white text-lg font-bold border-2 border-black hover:bg-gray-800">
                            CONNECT
                        </button>
                        <button onclick="syncTime()"
                                class="px-6 py-3 bg-white text-black text-lg font-bold border-2 border-black hover:bg-gray-100">
                            üïê SYNC TIME
                        </button>
                    </div>
                </div>
                <p id="connection-message" class="mt-4 text-lg font-bold text-black"></p>
            </section>

            <!-- Current Status Section -->
            <section class="bg-white border-4 border-black p-6 mb-6">
                <h2 class="text-2xl font-bold text-black mb-4">üìä CURRENT STATUS</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="border-2 border-black p-4 text-center">
                        <p class="text-lg font-bold text-black">CURRENT TIME</p>
                        <p id="current-time" class="text-2xl font-bold text-black">--:--:--</p>
                    </div>
                    <div class="border-2 border-black p-4 text-center">
                        <p class="text-lg font-bold text-black">BOOKS PLACED</p>
                        <p id="books-placed" class="text-2xl font-bold text-black">0 / 5</p>
                    </div>
                    <div class="border-2 border-black p-4 text-center">
                        <p class="text-lg font-bold text-black">TOTAL STUDY TIME</p>
                        <p id="total-time" class="text-2xl font-bold text-black">0h 0m</p>
                    </div>
                    <div class="border-2 border-black p-4 text-center">
                        <p class="text-lg font-bold text-black">MOOD</p>
                        <p id="current-mood" class="text-2xl font-bold text-black">üòä</p>
                    </div>
                </div>
            </section>

            <!-- Books Section -->
            <section class="bg-white border-4 border-black p-6 mb-6">
                <h2 class="text-2xl font-bold text-black mb-4">üìñ TODAY'S PROGRESS</h2>
                <div id="books-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Book cards will be inserted here -->
                </div>
            </section>

            <!-- ChatGPT Section -->
            <section class="bg-white border-4 border-black p-6 mb-6">
                <h2 class="text-2xl font-bold text-black mb-4">üí¨ ASK BOOK BUDDY</h2>
                <p class="text-lg font-bold text-black mb-4">Need help with your studies? Chat with Book Buddy's AI assistant!</p>
                <a href="https://chat.openai.com/?q=Hey%21%20I%27m%20Book%20Buddy%2C%20your%20study%20partner%21%20%F0%9F%93%9A%20What%27s%20on%20your%20mind%3F%20I%27m%20here%20to%20help%20you%20with%20your%20studies%2C%20answer%20questions%2C%20or%20just%20chat%20about%20learning%21" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="inline-block px-8 py-4 bg-black text-white text-xl font-bold border-2 border-black hover:bg-gray-800">
                    ü§ñ OPEN CHATGPT
                </a>
            </section>

            <!-- History Section -->
            <section class="bg-white border-4 border-black p-6">
                <h2 class="text-2xl font-bold text-black mb-4">üìÖ STUDY HISTORY</h2>
                <div id="history-container" class="space-y-2">
                    <p class="text-lg font-bold text-black text-center">No history data available</p>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t-4 border-black p-4 mt-6">
            <div class="max-w-6xl mx-auto text-center">
                <p class="text-lg font-bold text-black">üìö BOOK BUDDY - YOUR STUDY PARTNER üìö</p>
                <p class="text-md font-bold text-black mt-2">Keep your books close, knowledge closer!</p>
            </div>
        </footer>
    </div>

    <script>
        // Configuration
        const defaultConfig = {
            dashboard_title: 'BOOK BUDDY DASHBOARD',
            background_color: '#f3f4f6',
            text_color: '#000000',
            accent_color: '#000000'
        };

        let config = { ...defaultConfig };
        let websocket = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Book data structure
        const subjects = ['ENGLISH', 'MATHEMATICS', 'SCIENCE', 'HISTORY', 'GEOGRAPHY'];
        let bookData = {};
        let studyHistory = [];

        // Initialize book data
        subjects.forEach((subject, index) => {
            bookData[subject] = {
                id: `book_${index + 1}`,
                subject: subject,
                isPlaced: false,
                totalSeconds: 0,
                sessionStart: null,
                lastUpdated: new Date().toISOString()
            };
        });

        // Element SDK initialization
        const elementHandler = {
            defaultConfig: defaultConfig,
            onConfigChange: async (newConfig) => {
                config = { ...config, ...newConfig };
                updateUI();
            },
            mapToCapabilities: (cfg) => ({
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (cfg) => new Map([
                ['dashboard_title', cfg.dashboard_title || defaultConfig.dashboard_title]
            ])
        };

        // Data SDK handler
        const dataHandler = {
            onDataChanged: (data) => {
                if (data && data.length > 0) {
                    data.forEach(record => {
                        if (record.subject && bookData[record.subject]) {
                            bookData[record.subject].totalSeconds = record.total_seconds || 0;
                            bookData[record.subject].isPlaced = record.is_placed || false;
                            bookData[record.subject].lastUpdated = record.last_updated || new Date().toISOString();
                        }
                    });
                    renderBooks();
                    updateStats();
                }
            }
        };

        // Initialize SDKs
        async function initializeSDKs() {
            if (window.elementSdk) {
                await window.elementSdk.init(elementHandler);
            }
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error('Failed to initialize Data SDK');
                }
            }
            updateUI();
            renderBooks();
            startClock();
        }

        // Update UI based on config
        function updateUI() {
            const titleEl = document.getElementById('main-title');
            if (titleEl) {
                titleEl.textContent = 'üìö ' + (config.dashboard_title || defaultConfig.dashboard_title);
            }
        }

        // Render book cards
        function renderBooks() {
            const container = document.getElementById('books-container');
            if (!container) return;

            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const book = bookData[subject];
                const hours = Math.floor(book.totalSeconds / 3600);
                const minutes = Math.floor((book.totalSeconds % 3600) / 60);
                const seconds = book.totalSeconds % 60;
                
                const card = document.createElement('div');
                card.className = `book-card border-4 border-black p-4 ${book.isPlaced ? 'bg-green-100' : 'bg-white'}`;
                card.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-xl font-bold text-black mb-2">${subject}</h3>
                        <div class="text-4xl mb-2">${getBookEmoji(subject)}</div>
                        <p class="text-lg font-bold text-black">
                            STATUS: ${book.isPlaced ? '‚úÖ PLACED' : '‚ùå NOT PLACED'}
                        </p>
                        <p class="text-2xl font-bold text-black mt-2">
                            ${hours}h ${minutes}m ${seconds}s
                        </p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Get book emoji
        function getBookEmoji(subject) {
            const emojis = {
                'ENGLISH': 'üìï',
                'HINDI': 'üìò',
                'MATHS': 'üìó',
                'MARATHI': 'üìô',
                'SCIENCE': 'üìì'
            };
            return emojis[subject] || 'üìñ';
        }

        // Update statistics
        function updateStats() {
            const placedCount = Object.values(bookData).filter(b => b.isPlaced).length;
            const totalSeconds = Object.values(bookData).reduce((sum, b) => sum + b.totalSeconds, 0);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);

            const booksPlacedEl = document.getElementById('books-placed');
            const totalTimeEl = document.getElementById('total-time');
            const moodEl = document.getElementById('current-mood');

            if (booksPlacedEl) booksPlacedEl.textContent = `${placedCount} / 5`;
            if (totalTimeEl) totalTimeEl.textContent = `${hours}h ${minutes}m`;
            if (moodEl) moodEl.textContent = getMoodEmoji(placedCount);
        }

        // Get mood emoji based on books placed
        function getMoodEmoji(count) {
            const moods = ['üòê', 'üôÇ', 'üòä', 'üòÑ', 'üòÅ', 'ü§©'];
            return moods[Math.min(count, 5)];
        }

        // Start clock
        function startClock() {
            function updateClock() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                const timeEl = document.getElementById('current-time');
                if (timeEl) timeEl.textContent = timeStr;
            }
            updateClock();
        
